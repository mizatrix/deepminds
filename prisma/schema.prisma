generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String?
  role          String   @default("STUDENT") // SUPER_ADMIN, ADMIN, or STUDENT
  image         String?  // From OAuth providers
  provider      String?  @default("credentials")
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Profile fields
  avatar        String?  // Custom uploaded avatar
  faculty       String?  // For students (e.g., "Computer Science")
  year          String?  // For students (e.g., "1st Year", "2nd Year")
  studentId     String?  // For students
  department    String?  // For admins
  position      String?  // For admins (e.g., "Dean", "Professor")
  phone         String?
  bio           String?  // Max 500 characters
  
  // Social links (optional)
  linkedIn      String?
  github        String?
  twitter       String?
  website       String?
  
  // Profile completion tracking
  profileCompleted      Boolean @default(false)
  completionPercentage  Int     @default(0)
  
  // Email notification preferences
  emailNotifications    Boolean @default(true)
  emailDigestFrequency  String  @default("instant") // instant, daily, weekly, never
  
  // Account status
  isActive              Boolean @default(true)
  isDeleted             Boolean @default(false)
  deletedAt             DateTime?

  @@map("users")
}

model Submission {
  id               String   @id @default(cuid())
  studentEmail     String
  studentName      String
  title            String
  category         String
  orgName          String
  location         String
  achievementDate  String
  description      String
  evidenceUrl      String
  evidenceFileName String?
  evidenceFileType String?
  status           String   @default("PENDING") // PENDING, APPROVED, or REJECTED
  points           Int?
  submittedAt      DateTime @default(now())
  reviewedAt       DateTime?
  reviewedBy       String?
  adminFeedback    String?

  @@map("submissions")
}

model AuditLog {
  id              String   @id @default(cuid())
  timestamp       DateTime @default(now())
  action          String   // submit, approve, reject, delete
  performedBy     String
  performedByName String
  submissionId    String
  submissionTitle String
  details         String?

  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   // Email of the user (recipient)
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, ERROR, SUBMISSION_APPROVED, SUBMISSION_REJECTED, BADGE_EARNED, etc.
  read      Boolean  @default(false)
  link      String?  // Optional deep link (e.g., /student/submissions/123)
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}

model ScheduledNotification {
  id            String   @id @default(cuid())
  title         String
  message       String
  type          String   // MOTIVATIONAL, ANNOUNCEMENT
  priority      String   // LOW, NORMAL, HIGH, URGENT
  audience      String   // all, top_performers, new_students, inactive, high_achievers
  templateId    String?  // Optional: reference to template used
  scheduledFor  DateTime
  sent          Boolean  @default(false)
  sentAt        DateTime?
  createdBy     String   // Email of admin who created it
  createdAt     DateTime @default(now())
  
  @@index([scheduledFor, sent])
  @@map("scheduled_notifications")
}

model NotificationReaction {
  id                String   @id @default(cuid())
  notificationId    String
  userId            String   // Email of the user
  reactionType      String   // like, love, celebrate, inspire
  createdAt         DateTime @default(now())
  
  @@unique([notificationId, userId])
  @@index([notificationId])
  @@map("notification_reactions")
}

model NotificationAnalytics {
  id                String   @id @default(cuid())
  notificationId    String
  userId            String
  opened            Boolean  @default(false)
  openedAt          DateTime?
  clicked           Boolean  @default(false)
  clickedAt         DateTime?
  createdAt         DateTime @default(now())
  
  @@unique([notificationId, userId])
  @@index([notificationId])
  @@map("notification_analytics")
}

model NotificationTrigger {
  id            String   @id @default(cuid())
  name          String
  type          String   // scheduled, milestone
  enabled       Boolean  @default(true)
  schedule      String?  // Cron expression
  templateId    String
  audience      String
  lastRun       DateTime?
  nextRun       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("notification_triggers")
}

model TriggerExecution {
  id          String   @id @default(cuid())
  triggerId   String
  executedAt  DateTime @default(now())
  success     Boolean
  sent        Int
  failed      Int
  error       String?
  
  @@index([triggerId])
  @@map("trigger_executions")
}

model Badge {
  id              String      @id @default(cuid())
  name            String      @unique
  description     String
  icon            String      // Lucide icon name: "Star", "Zap", "Trophy"
  color           String      @default("purple")
  category        String?     // Null = general badge, string = category-specific
  triggerType     String      // "first_submission", "category_count", "total_points"
  triggerValue    Int         @default(1)
  createdAt       DateTime    @default(now())

  userBadges      UserBadge[]
  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String   // User email
  badgeId   String
  earnedAt  DateTime @default(now())

  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

// System-wide settings stored in database
model SystemSettings {
  id                    String   @id @default("singleton") // Only one row
  portalName            String   @default("CS Excellence Portal")
  maintenanceMode       Boolean  @default(false)
  allowRegistrations    Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  autoApproveScientific Boolean  @default(false)
  termsJson             String   @default("[]") // JSON array of academic terms
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // Email of last admin who updated

  @@map("system_settings")
}
